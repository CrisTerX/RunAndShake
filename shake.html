<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shake Test</title>
<style>
  body { font-family: Arial, sans-serif; background: #111; color: #eee; text-align: center; padding: 20px; }
  h2 { color: #0ff; }
  button { padding: 10px 20px; margin: 10px; font-size: 16px; cursor: pointer; border-radius: 8px; border: none; background: #09f; color: #fff; }
  #statusBox { margin-top: 20px; padding: 15px; border: 1px solid #444; border-radius: 10px; background: #222; text-align: left; display: inline-block; width: 90%; max-width: 500px; }
  .ok { color: #0f0; }
  .fail { color: #f33; }
  .warn { color: #fc3; }
</style>
</head>
<body>
  <h2>Shake Test</h2>
  <button id="shakeBtn">Simulate Shake</button>

  <div id="statusBox">
    <p id="connectStatus">üïì Connecting...</p>
    <p id="motionStatus">Motion Sensor: ‚è≥</p>
    <p id="networkStatus">Network Test: ‚è≥</p>
    <p id="nodeStatus">Node.js Status: ‚è≥</p>
    <p id="ipInfo">Connecting to IP: -</p>
  </div>

<script>
let ws;
let ipAddr = "";
const connectEl = document.getElementById("connectStatus");
const motionEl = document.getElementById("motionStatus");
const networkEl = document.getElementById("networkStatus");
const nodeEl = document.getElementById("nodeStatus");
const ipEl = document.getElementById("ipInfo");
const btn = document.getElementById("shakeBtn");

// ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö motion sensor
if (window.DeviceMotionEvent) {
  motionEl.innerHTML = "Motion Sensor: ‚úÖ";
} else {
  motionEl.innerHTML = "Motion Sensor: ‚ùå ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ö‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ";
}

// üì° ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket
function connectWS() {
  ipAddr = prompt("‡∏Å‡∏£‡∏≠‡∏Å IP ‡∏Ç‡∏≠‡∏á Node.js Bridge:", "192.168.1.206");
  if (!ipAddr) return;
  ipEl.innerHTML = `Connecting to IP: ${ipAddr}`;
  const wsUrl = `ws://${ipAddr}:9090`;

  try {
    ws = new WebSocket(wsUrl);
  } catch (e) {
    showError(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á WebSocket: ${e.message}`);
    return;
  }

  ws.onopen = () => {
    connectEl.innerHTML = `‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${wsUrl}`;
    networkEl.innerHTML = "Network Test: ‚úÖ";
  };

  ws.onerror = (event) => {
    showError(`‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, event);
  };

  ws.onclose = () => {
    connectEl.innerHTML = "‚ùå ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î";
    networkEl.innerHTML = "Network Test: ‚ùå";
  };
}

// üîÑ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö Node.js Bridge ‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡∏£‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°
async function checkNodeStatus(ip) {
  try {
    const res = await fetch(`http://${ip}:9090/status?_=${Date.now()}`);
    if (!res.ok) throw new Error("Response not OK");
    const data = await res.json();
    nodeEl.innerHTML = `Node.js Status: <span class="ok">üü¢ ${data.status} (${data.uptime})</span>`;
  } catch (err) {
    nodeEl.innerHTML = `Node.js Status: <span class="fail">üî¥ Offline (${err.message})</span>`;
  }
}

// ‚ùå ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
function showError(message, event) {
  connectEl.innerHTML = `
  ‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à<br>
  ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ:<br>
  - IP ‡∏ú‡∏¥‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Wi-Fi ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô<br>
  - Node.js Bridge ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà<br>
  - Firewall ‡∏´‡∏£‡∏∑‡∏≠ Antivirus ‡∏ö‡∏•‡πá‡∏≠‡∏Ñ‡∏û‡∏≠‡∏£‡πå‡∏ï 9090<br>
  - Browser ‡∏ö‡∏•‡πá‡∏≠‡∏Ñ Cross-Origin<br><br>
  üßæ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${message}<br>
  ${event ? ("<pre>" + JSON.stringify(event, null, 2) + "</pre>") : ""}
  `;
  networkEl.innerHTML = "Network Test: ‚ùå";
}

// üì§ ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏≥‡∏•‡∏≠‡∏á Shake
btn.addEventListener("click", () => {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send("shake");
  } else {
    alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Node.js Bridge!");
  }
});

// üì± ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏ô‡∏à‡∏£‡∏¥‡∏á
window.addEventListener('devicemotion', (event) => {
  const a = event.accelerationIncludingGravity;
  if (!a) return;
  const total = Math.abs(a.x) + Math.abs(a.y) + Math.abs(a.z);
  if (total > 20 && ws && ws.readyState === WebSocket.OPEN) {
    ws.send("shake");
  }
});

// üîÅ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Node.js ‡∏ó‡∏∏‡∏Å‡πÜ 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
setInterval(() => {
  if (ipAddr) checkNodeStatus(ipAddr);
}, 5000);

// üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
connectWS();
</script>
</body>
</html>
