<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shake Debug Tester</title>
<style>
body { font-family: sans-serif; text-align: center; background: #111; color: white; padding: 40px; }
input, button { font-size: 18px; margin: 10px; padding: 10px; border-radius: 8px; }
button { background: #28a745; color: white; border: none; }
#status { margin-top: 20px; text-align:left; white-space: pre-line; }
</style>
</head>
<body>

<h1>ðŸ“± Shake Debug Tester</h1>

<p>à¹ƒà¸ªà¹ˆ IP à¸‚à¸­à¸‡ PC (Unity Editor)</p>
<input type="text" id="ipInput" placeholder="à¹€à¸Šà¹ˆà¸™ 192.168.1.12" />
<button id="connectBtn">Connect & Test</button>
<button id="shakeBtn" style="display:none;">à¸ªà¹ˆà¸‡ shake</button>

<pre id="status">à¸ªà¸–à¸²à¸™à¸°:\n</pre>

<script>
const port = 7070;
let serverIP = "";

// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸—à¸”à¸ªà¸­à¸š network
async function sendShake() {
  if (!serverIP) return;
  updateStatus("à¸à¸³à¸¥à¸±à¸‡à¸ªà¹ˆà¸‡ shake...");
  try {
    await fetch(`http://${serverIP}:${port}/?msg=shake`);
    updateStatus("à¸ªà¹ˆà¸‡ shake à¸ªà¸³à¹€à¸£à¹‡à¸ˆ âœ…");
  } catch(err) {
    updateStatus("à¸ªà¹ˆà¸‡ shake à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ âŒ à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š IP / Port / Network\n" + err);
  }
}

// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸­à¸±à¸›à¹€à¸”à¸•à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ status
function updateStatus(msg) {
  const s = document.getElementById("status");
  s.textContent += msg + "\n";
  console.log(msg);
}

// à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š DeviceMotion permission
async function checkMotionPermission() {
  if (typeof DeviceMotionEvent.requestPermission === "function") {
    updateStatus("à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š permission Motion Sensor...");
    try {
      const response = await DeviceMotionEvent.requestPermission();
      if (response === "granted") {
        updateStatus("Motion Sensor âœ…");
      } else {
        updateStatus("Motion Sensor âŒ à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸›à¸à¸´à¹€à¸ªà¸˜ permission");
      }
    } catch(err) {
      updateStatus("Motion Sensor âŒ Error: " + err);
    }
  } else {
    updateStatus("Motion Sensor âœ… à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸‚à¸­ permission (Browser à¸£à¸­à¸‡à¸£à¸±à¸šà¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´)");
  }
}

// à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š WebSocket / fetch network
async function testNetwork(ip) {
  try {
    const res = await fetch(`http://${ip}:${port}/?msg=test`);
    updateStatus("Network test âœ… fetch à¸–à¸¶à¸‡ Unity / Server");
  } catch(err) {
    updateStatus("Network test âŒ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸– fetch à¸–à¸¶à¸‡ Unity / Server\n" + err);
  }
}

// à¸›à¸¸à¹ˆà¸¡ Connect
document.getElementById("connectBtn").addEventListener("click", async () => {
  serverIP = document.getElementById("ipInput").value.trim();
  if (!serverIP) { alert("à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸ IP"); return; }
  document.getElementById("shakeBtn").style.display = "inline-block";
  updateStatus("à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸à¸±à¸š: " + serverIP + ":" + port);

  await checkMotionPermission();
  await testNetwork(serverIP);
});

// à¸›à¸¸à¹ˆà¸¡à¸ªà¹ˆà¸‡ shake
document.getElementById("shakeBtn").addEventListener("click", sendShake);

// à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸šà¸à¸²à¸£à¹€à¸‚à¸¢à¹ˆà¸²à¹à¸šà¸šà¸ˆà¸£à¸´à¸‡
if (window.DeviceMotionEvent) {
  let lastShake = 0;
  window.addEventListener("devicemotion", (event) => {
    const acc = event.accelerationIncludingGravity;
    const strength = Math.abs(acc.x) + Math.abs(acc.y) + Math.abs(acc.z);
    if (strength > 30 && Date.now() - lastShake > 2000) {
      lastShake = Date.now();
      updateStatus("ðŸ“³ à¹€à¸‚à¸¢à¹ˆà¸² detected! strength=" + strength);
      sendShake();
    }
  });
}
</script>

</body>
</html>
