<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shake Test (Smart Debug + Ping)</title>
<style>
  body { font-family: sans-serif; background: #111; color: #eee; text-align: center; padding: 20px; }
  h2 { color: #4FC3F7; }
  #log { text-align: left; background: #222; padding: 10px; border-radius: 10px; height: 220px; overflow-y: auto; }
  button { background: #4CAF50; color: white; padding: 10px 20px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; }
  button:hover { background: #66BB6A; }
  .error { color: #F44336; }
  .ok { color: #4CAF50; }
  .warn { color: #FF9800; }
</style>
</head>
<body>
  <h2>üì± Shake Test (Smart Debug + Ping)</h2>
  <p id="status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span style="color:orange">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...</span></p>
  <button id="shakeBtn">Simulate Shake</button>
  <button id="pingBtn">Ping Test üîÑ</button>
  <div id="log"></div>

<script>
const logEl = document.getElementById("log");
const statusEl = document.getElementById("status");
const btnShake = document.getElementById("shakeBtn");
const btnPing = document.getElementById("pingBtn");

let ws;
let ipAddr;
let deviceMotionOK = false;

function log(msg, type="") {
  const color =
    type === "error" ? "red" :
    type === "ok" ? "lightgreen" :
    type === "warn" ? "orange" : "white";
  logEl.innerHTML += `<div style="color:${color}">${msg}</div>`;
  logEl.scrollTop = logEl.scrollHeight;
}

// üü¢ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö Ping ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Node.js Bridge
async function pingTest(ip) {
  const url = `http://${ip}:9090/ping?_=${Date.now()}`;
  const start = performance.now();
  try {
    const res = await fetch(url, { method: "GET", mode: "cors" });
    const text = await res.text();
    const end = performance.now();
    const ms = Math.round(end - start);
    if (res.ok && text.includes("pong")) {
      log(`‚úÖ Node.js Bridge ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö: pong (${ms} ms)`, "ok");
      return true;
    } else {
      log(`‚ö†Ô∏è Ping ‡πÑ‡∏î‡πâ‡πÅ‡∏ï‡πà‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (${ms} ms): ${text}`, "warn");
      return false;
    }
  } catch (err) {
    log(`‚ùå Ping ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${err.message})`, "error");
    log("‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ:", "error");
    log("- Node.js Bridge ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ô", "error");
    log("- ‡∏û‡∏≠‡∏£‡πå‡∏ï 9090 ‡∏ñ‡∏π‡∏Å Firewall ‡∏ö‡∏•‡πá‡∏≠‡∏Ñ", "error");
    log("- ‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Wi-Fi ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô", "error");
    return false;
  }
}

// üß© ‡∏ó‡∏î‡∏™‡∏≠‡∏ö WebSocket Connection
async function testConnection(ip) {
  const url = `ws://${ip}:9090`;
  log(`üîç ‡∏ó‡∏î‡∏™‡∏≠‡∏ö WebSocket: ${url}`);

  try {
    ws = new WebSocket(url);
  } catch (e) {
    log(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á WebSocket ‡πÑ‡∏î‡πâ (${e.message})`, "error");
    return;
  }

  ws.onopen = () => {
    log(`‚úÖ WebSocket ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${url}`, "ok");
    statusEl.innerHTML = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span class='ok'>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>`;
  };

  ws.onerror = (err) => {
    log(`‚ùå WebSocket ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, "error");
    log(`- IP ‡∏≠‡∏≤‡∏à‡∏ú‡∏¥‡∏î ‡∏´‡∏£‡∏∑‡∏≠ Node.js ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ô`, "error");
    log(`- ‡∏û‡∏≠‡∏£‡πå‡∏ï 9090 ‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Ñ`, "error");
    log(`üßæ Error: ${err.message || err}`, "error");
    statusEl.innerHTML = `<span class="error">‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>`;
  };

  ws.onclose = () => log("üî¥ ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î");
}

// üì± ‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Motion Sensor
async function checkMotionPermission() {
  if (typeof DeviceMotionEvent.requestPermission === "function") {
    const res = await DeviceMotionEvent.requestPermission();
    if (res === "granted") {
      deviceMotionOK = true;
      log("‚úÖ Motion Sensor: ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÅ‡∏•‡πâ‡∏ß", "ok");
    } else {
      log("‚ùå Motion Sensor: ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò", "error");
    }
  } else {
    deviceMotionOK = true;
    log("‚úÖ Motion Sensor: ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï)", "ok");
  }
}

// üì§ ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏¢‡πà‡∏≤
btnShake.addEventListener("click", () => {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send("shake");
    log("üì§ ‡∏™‡πà‡∏á shake -> Unity ‡πÅ‡∏•‡πâ‡∏ß", "ok");
  } else {
    log("‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket", "error");
  }
});

// üîÅ ‡∏õ‡∏∏‡πà‡∏° Ping Test
btnPing.addEventListener("click", async () => {
  if (!ipAddr) return log("‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ IP", "warn");
  log("üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á Ping...");
  await pingTest(ipAddr);
});

// üì≥ ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏¢‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á
window.addEventListener("devicemotion", (e) => {
  if (!deviceMotionOK || !ws || ws.readyState !== WebSocket.OPEN) return;
  const a = e.accelerationIncludingGravity;
  const total = Math.abs(a.x) + Math.abs(a.y) + Math.abs(a.z);
  if (total > 20) {
    ws.send("shake");
    log("üì≥ ‡πÄ‡∏Ç‡∏¢‡πà‡∏≤‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ -> ‡∏™‡πà‡∏á shake ‡πÅ‡∏•‡πâ‡∏ß", "ok");
  }
});

// üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
(async () => {
  ipAddr = prompt("‡∏Å‡∏£‡∏≠‡∏Å IP ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á Node.js Bridge (‡πÄ‡∏ä‡πà‡∏ô 192.168.1.206):", "192.168.1.206");
  if (!ipAddr) return log("‚ùå ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏£‡∏≠‡∏Å IP", "error");
  log(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏±‡∏ö: ${ipAddr}`);
  await checkMotionPermission();
  const alive = await pingTest(ipAddr);
  if (alive) await testConnection(ipAddr);
})();
</script>
</body>
</html>
