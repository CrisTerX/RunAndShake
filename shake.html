<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shake Test (Smart Debug)</title>
<style>
  body { font-family: sans-serif; background: #111; color: #eee; text-align: center; padding: 20px; }
  h2 { color: #4FC3F7; }
  #log { text-align: left; background: #222; padding: 10px; border-radius: 10px; height: 180px; overflow-y: auto; }
  button { background: #4CAF50; color: white; padding: 10px 20px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; }
  button:hover { background: #66BB6A; }
  .error { color: #F44336; }
  .ok { color: #4CAF50; }
</style>
</head>
<body>
  <h2>üì± Shake Test (Smart Debug)</h2>
  <p id="status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span style="color:orange">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...</span></p>
  <button id="shakeBtn">Simulate Shake</button>
  <div id="log"></div>

<script>
const logEl = document.getElementById("log");
const statusEl = document.getElementById("status");
const btn = document.getElementById("shakeBtn");

let ws;
let deviceMotionOK = false;

function log(msg, type="") {
  const color = type === "error" ? "red" : type === "ok" ? "lightgreen" : "white";
  logEl.innerHTML += `<div style="color:${color}">${msg}</div>`;
  logEl.scrollTop = logEl.scrollHeight;
}

async function testConnection(ip) {
  const url = `ws://${ip}:9090`;
  log(`üîç ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ${url}`);

  try {
    ws = new WebSocket(url);
  } catch (e) {
    log(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á WebSocket ‡πÑ‡∏î‡πâ (${e.message})`, "error");
    return;
  }

  ws.onopen = () => {
    log(`‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Å‡∏±‡∏ö ${url}`, "ok");
    statusEl.innerHTML = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span class='ok'>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>`;
  };

  ws.onerror = (err) => {
    log(`‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, "error");
    log(`‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ:`, "error");
    log(`- IP ‡∏ú‡∏¥‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Wi-Fi ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô`, "error");
    log(`- Node.js Bridge ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà`, "error");
    log(`- Firewall ‡∏´‡∏£‡∏∑‡∏≠ Antivirus ‡∏ö‡∏•‡πá‡∏≠‡∏Ñ‡∏û‡∏≠‡∏£‡πå‡∏ï 9090`, "error");
    log(`- Browser ‡∏ö‡∏•‡πá‡∏≠‡∏Ñ Cross-Origin`, "error");
    log(`üßæ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${err.message || err}`, "error");
    statusEl.innerHTML = `<span class="error">‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>`;
  };

  ws.onclose = () => {
    log("üî¥ ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î");
  };
}

async function checkMotionPermission() {
  if (typeof DeviceMotionEvent.requestPermission === "function") {
    const res = await DeviceMotionEvent.requestPermission();
    if (res === "granted") {
      deviceMotionOK = true;
      log("‚úÖ Motion Sensor: ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÅ‡∏•‡πâ‡∏ß", "ok");
    } else {
      log("‚ùå Motion Sensor: ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò", "error");
    }
  } else {
    deviceMotionOK = true;
    log("‚úÖ Motion Sensor: ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï)", "ok");
  }
}

btn.addEventListener("click", () => {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send("shake");
    log("üì§ ‡∏™‡πà‡∏á shake -> Unity ‡πÅ‡∏•‡πâ‡∏ß", "ok");
  } else {
    log("‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket", "error");
  }
});

window.addEventListener("devicemotion", (e) => {
  if (!deviceMotionOK || !ws || ws.readyState !== WebSocket.OPEN) return;
  const a = e.accelerationIncludingGravity;
  const total = Math.abs(a.x) + Math.abs(a.y) + Math.abs(a.z);
  if (total > 20) {
    ws.send("shake");
    log("üì≥ ‡πÄ‡∏Ç‡∏¢‡πà‡∏≤‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ -> ‡∏™‡πà‡∏á shake ‡πÅ‡∏•‡πâ‡∏ß", "ok");
  }
});

(async () => {
  const ip = prompt("‡∏Å‡∏£‡∏≠‡∏Å IP ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á Node.js Bridge (‡πÄ‡∏ä‡πà‡∏ô 192.168.1.206):", "192.168.1.206");
  log(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö: ${ip}`);
  await checkMotionPermission();
  await testConnection(ip);
})();
</script>
</body>
</html>
